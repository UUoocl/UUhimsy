<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="UTF-8" />
        <title>Display Control</title>
        <style>
            .button.xxl, .sl-select.xxl, .sl-checkbox.xxl label {
                padding: 30px 40px;
                font-size: 4em;
                border-radius: 10px;
                font-weight: 1000;
                -webkit-font-smoothing: antialiased;
            }
            
            .button.grey {
                background: #3f4d52;
            }
            
            .button {
                display: inline-block;
                color: #fff;
                text-decoration: none;
                font-family: "Inter", Helvetica, sans-serif;
                font-weight: normal;
                font-size: inherit;
                line-height: 1;
                outline: 0;
                width: 100%;
                border: 10;
                border-color: aliceblue;
                border-radius: 4px;
                background: #3f4d52;
                cursor: pointer;
                -webkit-appearance: none;
                -webkit-tap-highlight-color: transparent;
                padding: 8px 12px;
            }
            </style>
</head>

<body>
    <button id="fullScreen" class="button grey xxl" type="button" onclick="fullScreen()">Full Screen</button><br>
    <button id="followMouse" class="button grey xxl" type="button" onclick="followMouse(mouseCoordinates)">Follow Mouse</button><br>
    <button id="followMouseAndZoom" class="button grey xxl" type="button" onclick="zoomAndFollowMouse(mouseCoordinates)">Follow Mouse and Zoom In</button><br>
    
    <button id="refreshBrowsers" class="button grey xxl" type="button" onclick="refreshOBSbrowsers()">Refresh All Browser Sources</button><br>
    
    <script src="obs_webSocket_details/websocketDetails.js"></script>
    <script src="obs_webSocket_details/obs-ws.js"></script>
    <script src="obs_webSocket_details/obsConnect.js"></script>
    <!-- <script src="lib/SCRIPT_FOR_THIS_Page.js"></script> -->

    <script>
        // Connect to OBS
        const obs = new OBSWebSocket();
        wsConnect();

        async function wsConnect() {
            await connectOBS(obs);
        }
        </script>
    <script>
        //listen for events
        //on obs input change
        obs.on("InputSettingsChanged", async function (event) {
            //console.log(event);
            switch (event.inputName) {
                case 'cursor':
                    //console.log(mouseCoordinates);
                    mouseCoordinates = event.inputSettings.text.split(' ')
                    if(viewMode === "zoomAndFollowMouse"){
                        zoomAndFollowMouse(mouseCoordinates);
                        break;
                    }
                    if(viewMode === "followMouse"){
                        followMouse(mouseCoordinates);
                        break;
                    }
                    if(viewMode === "fullScreen"){
                        break;
                    }
                    break;
                    
                case 'hotkeyText':
                    console.log(event);
                    if(event.inputSettings.text === ' '){
                        break;
                    }
                    if(event.inputSettings.text === ('F16')){ 
                        zoomAndFollowMouse(mouseCoordinates)
                        break;
                    }
                    if(event.inputSettings.text === ('F15')){ 
                        followMouse(mouseCoordinates)
                        break;
                    }
                    if(event.inputSettings.text === ('F14')){ 
                        fullScreen();
                        break;
                    }
                    break;
                    default:
                        break;
                    }
                })
                
                //f14 full screen
                
                function fullScreen() {
                    viewMode = 'fullScreen';
                    obs.call('SetSourceFilterSettings', {
                        'sourceName': `Source Clone FG`,
                        'filterName': "Move Value",
                        'filterSettings': {
                            // "move_value_type": 1,
                            // "rectangle_corner_radius": 0.0,
                    // "shape_center_x": 960.0,
                    // "shape_center_y": 540.0,
                    // "shape_rotation": 0.0,
                    // "rectangle_width": 1920.0,
                    // "rectangle_height": 1080.0,
                    // "source_zoom": 100.0          

                    "circle_radius": 1100,
                    "duration": 300,
                    "filter": "Advanced Mask",
                    "mask_gradient_position": 960,
                    "mask_source_filter_multiplier": 1,
                    "move_value_type": 1,
                    "position_scale": 100,
                    "position_x": 960,
                    "position_y": 540,
                    "rectangle_corner_radius": 0,
                    "rectangle_corner_type": 1,
                    "rectangle_height": 1080,
                    "rectangle_width": 1920,
                    "scale_type": 1,
                    "setting_float": 938,
                    "setting_float_max": 930,
                    "setting_float_min": 930,
                    "setting_name": "shape_center_x",
                    "shape_center_x": 960,
                    "shape_center_y": 540,
                    "shape_feather_type": 1,
                    "shape_relative": true,
                    "shape_rotation": 0,
                    "source_zoom": 100,
                    "value_type": 0

                },
                overlay: true
            })

            obs.call('SetSourceFilterEnabled', {
                'sourceName': `Source Clone FG`,
                'filterName': "Move Value",
                'filterEnabled': true
            })
        }

        //f15 follow mouse

        function followMouse(coordinates){
            //initialize follow mouse mode
            if(viewMode != 'followMouse'){
                viewMode = 'followMouse';
                sourceHeight = 500;
                sourceWidth = sourceHeight*1.7777778
                //Set mouseBoundary variables l,r,t,b
                mouseBoundaryLeft = 0,
                mouseBoundaryRight = 0,
                mouseBoundaryTop = 0,
                mouseBoundaryBottom = 0
            }

            console.log("coordinates FollowMouse()",coordinates)
            mouseX = Number(coordinates[0]);
            
            mouseY = Number(coordinates[1])
            
            //if mouse not in boundary area
            if(((mouseX < mouseBoundaryLeft) || (mouseX > mouseBoundaryRight)) || ((mouseY < mouseBoundaryTop) || (mouseY > mouseBoundaryBottom))){
                //Set mouseBoundary variables l,r,t,b
                //check if mouse is near edge X, Y
                if((mouseX - (sourceWidth/2)) < displayXmin){
                    mouseX = (displayXmin + (sourceWidth/2));
                }
                if((mouseX + (sourceWidth/2)) > displayXmax){
                    mouseX = (displayXmax - (sourceWidth/2));
                }
                if((mouseY - (sourceHeight/2)) < displayYmin){
                    mouseY = (displayYmin + (sourceHeight/2));
                }
                if((mouseY + (sourceHeight/2)) > displayYmax){
                    mouseY = (displayYmax - (sourceHeight/2));
                }
                
                mouseBoundaryLeft = (mouseX-(sourceWidth*boundarySize)) 
                mouseBoundaryRight = mouseX+((sourceWidth*boundarySize))
                mouseBoundaryTop = mouseY-((sourceHeight*boundarySize))
                mouseBoundaryBottom = mouseY+((sourceHeight*boundarySize))   
                console.log(mouseBoundaryLeft,mouseBoundaryRight,mouseBoundaryTop,mouseBoundaryBottom) 
                

                //Set Filter Settings
                obs.call('SetSourceFilterSettings', { 
                    'sourceName': `Source Clone FG`,
                    'filterName': "Move Value",
                    'filterSettings': {
                        "circle_radius": Number(sourceFilterRadius),
                        "duration": 300,
                        "easing_function_match": 5,
                        "easing_match": 0,
                        "end_delay": 0,
                        "filter": "Advanced Mask",
                        "heart_size": 800,
                        "mask_gradient_position": 960,
                        "mask_gradient_rotation": 0,
                        "mask_gradient_width": 500,
                        "mask_source_filter_multiplier": 1,
                        "move_value_type": 1,
                        "position_scale": 100,
                        "position_x": Number(mouseX),
                        "position_y": Number(mouseY),
                        "rectangle_corner_radius": 20,
                        "rectangle_corner_type": 1,
                        "rectangle_height": Number(sourceHeight),
                        "rectangle_width":  Number(sourceWidth),
                        "scale_type": 1,
                        "setting_float": 938,
                        "setting_float_max": 930,
                        "setting_float_min": 930,
                        "setting_name": "shape_center_x",
                        "shape_center_x": Number(mouseX),
                        "shape_center_y": Number(mouseY),
                        "shape_ellipse_a": 800,
                        "shape_ellipse_b": 600,
                        "shape_feather_amount": 0,
                        "shape_feather_type": 1,
                        "shape_relative": true,
                        "shape_rotation": 0,
                        "shape_star_inner_radius": 50,
                        "shape_star_num_points": 5,
                        "shape_star_outer_radius": 400,
                        "source_range_max": 0,
                        "source_range_min": 0,
                        "source_zoom": Number(sourceFilterZoom),
                        "star_corner_radius": 0,
                        "value_type": 2
                    },
                    overlay: true
                }
            )
            obs.call('SetSourceFilterEnabled',{
                'sourceName': `Source Clone FG`,
                'filterName': "Move Value",
                'filterEnabled': true
            })
        }
    }
        
        //
        function moveMouse(coordinates){}

        //f16 zoom region
        function zoomAndFollowMouse(coordinates){
            //initialize follow mouse mode
            if(viewMode != 'zoomAndFollowMouse'){
                viewMode = 'zoomAndFollowMouse';
                sourceHeight = 500;
                sourceWidth = sourceHeight*1.7777778
                //Set mouseBoundary variables l,r,t,b
                mouseBoundaryLeft = 0,
                mouseBoundaryRight = 0,
                mouseBoundaryTop = 0,
                mouseBoundaryBottom = 0
            }

            console.log("coordinates FollowMouse()",coordinates)
            mouseX = Number(coordinates[0]);
            
            mouseY = Number(coordinates[1])
            
            //if mouse not in boundary area
            if(((mouseX < mouseBoundaryLeft) || (mouseX > mouseBoundaryRight)) || ((mouseY < mouseBoundaryTop) || (mouseY > mouseBoundaryBottom))){
                //Set mouseBoundary variables l,r,t,b
                //check if mouse is near edge X, Y
                if((mouseX - (sourceWidth/2)) < displayXmin){
                    mouseX = (displayXmin + (sourceWidth/2));
                }
                if((mouseX + (sourceWidth/2)) > displayXmax){
                    mouseX = (displayXmax - (sourceWidth/2));
                }
                if((mouseY - (sourceHeight/2)) < displayYmin){
                    mouseY = (displayYmin + (sourceHeight/2));
                }
                if((mouseY + (sourceHeight/2)) > displayYmax){
                    mouseY = (displayYmax - (sourceHeight/2));
                }
                
                mouseBoundaryLeft = (mouseX-(sourceWidth*boundarySize)) 
                mouseBoundaryRight = mouseX+((sourceWidth*boundarySize))
                mouseBoundaryTop = mouseY-((sourceHeight*boundarySize))
                mouseBoundaryBottom = mouseY+((sourceHeight*boundarySize))   
                console.log(mouseBoundaryLeft,mouseBoundaryRight,mouseBoundaryTop,mouseBoundaryBottom) 
                

                //Set Filter Settings
                obs.call('SetSourceFilterSettings', { 
                    'sourceName': `Source Clone FG`,
                    'filterName': "Move Value",
                    'filterSettings': {
                        "circle_radius": 100,
                        "duration": 300,
                        "easing_function_match": 5,
                        "easing_match": 0,
                        "end_delay": 0,
                        "filter": "Advanced Mask",
                        "heart_size": 800,
                        "mask_gradient_position": 960,
                        "mask_gradient_rotation": 0,
                        "mask_gradient_width": 500,
                        "mask_source_filter_multiplier": 1,
                        "move_value_type": 1,
                        "position_scale": 180,
                        "position_x": 920,
                        "position_y": 540,
                        "rectangle_corner_radius": 20,
                        "rectangle_corner_type": 1,
                        "rectangle_height": 540,
                        "rectangle_width":  960,
                        "scale_type": 1,
                        "setting_float": 938,
                        "setting_float_max": 930,
                        "setting_float_min": 930,
                        "setting_name": "shape_center_x",
                        "shape_center_x": Number(mouseX),
                        "shape_center_y": Number(mouseY),
                        "shape_ellipse_a": 800,
                        "shape_ellipse_b": 600,
                        "shape_feather_amount": 0,
                        "shape_feather_type": 1,
                        "shape_relative": true,
                        "shape_rotation": 0,
                        "shape_star_inner_radius": 50,
                        "shape_star_num_points": 5,
                        "shape_star_outer_radius": 400,
                        "source_range_max": 0,
                        "source_range_min": 0,
                        "source_zoom": 100,
                        "star_corner_radius": 0,
                        "value_type": 2
                        
                    },
                    overlay: true
                }
            )
            obs.call('SetSourceFilterEnabled',{
                'sourceName': `Source Clone FG`,
                'filterName': "Move Value",
                'filterEnabled': true
            })
        }
    
        }



        // follow shape
        function setShape(followShape){}

        function setShapeSize(amount){
        // follow size increase

        // follow size decrease
    }

        function setZoom(){
        // zoom increase
        // zoom decrease
        }

      
    </script>
    <script>
        //Variables
        var viewMode = 'fullScreen', 
        mouseX,
        mouseY,
        mouseCoordinates = [0,0],
        displayWidth = 1920, 
        displayHeight = 1080, 
        displayXmin = 0,
        displayYmin = 0,
        displayXmax = displayXmin + displayWidth,
        displayYmax = displayYmin + displayHeight,
        sourceFilterRadius = 1100,
        sourceWidth = 1920,
        sourceHeight = 1080,
        sourceFilterZoom = 100,
        boundarySize = 0.5, // (.01 -.5)

        mouseBoundaryLeft = 0,
        mouseBoundaryTop = 0,
        mouseBoundaryRight = 0,
        mouseBoundaryBottom = 0
        
        
    </script>
    <script>
        async function refreshOBSbrowsers(){
        let SceneItems = await obs.call("GetInputList", {
            inputKind: "browser_source",
        });
        console.log("1: ", SceneItems)

        SceneItems = SceneItems.inputs;
        console.log("2: ",SceneItems)
        const browsers = await SceneItems.filter(async (item) => {
            console.log("item",item)
            if (item.inputKind == "browser_source") {
            await obs.call("PressInputPropertiesButton", {
                inputUuid: item.inputUuid,
                propertyName: "refreshnocache",
            });
            }
        });
        //setTimeout(connectOBS,1000)
        console.log('browser refresh complete')
        }

    </script>
</body>

</html>